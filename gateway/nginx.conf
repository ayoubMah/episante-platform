events {
    worker_connections 1024;
}

http {
    # Optimization for file transfers
    sendfile on;

    # 1. Common Proxy Settings (Don't repeat yourself)
    # These headers ensure the backend knows the Real IP and Protocol (HTTP vs HTTPS)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    server {
        listen 80;

        # --- 1. Frontend (Vite/React) ---
        location / {
            proxy_pass http://frontend:80;

            # WebSocket Support for Vite HMR (Hot Module Replacement)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # --- 2. Auth Service (CRITICAL: Added this) ---
        # Routes: /api/auth/login, /api/auth/register
        location /api/auth {
            proxy_pass http://auth-service:9094;
        }

        # --- 3. Doctor Service ---
        location /api/doctors {
            proxy_pass http://doctor-service:9092;
        }

        # --- 4. Patient Service ---
        location /api/patients {
            proxy_pass http://patient-service:9091;
        }

        # --- 5. Appointment Service ---
        location /api/appointments {
            proxy_pass http://appointment-service:9093;
        }

        # --- SECURITY NOTE: Internal Endpoints ---
        # Note that we do NOT have a location block for /internal.
        # Any request to http://localhost/internal/doctors will fall through to
        # location / (Frontend) and return 404.
        # This effectively blocks external access to your private APIs.
    }
}